name: deploy

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

env:
  GCS_PREFIX: ${{ secrets.GCS_PREFIX }}
  SA_ID:      ${{ secrets.SA_ID }}


jobs:
  build-deploy:
    name: Builds and releases the site
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - id: 'checkout'
      uses: 'actions/checkout@v3'

    - id: 'auth'
      uses: 'google-github-actions/auth@v1'
      with:
        service_account: '$SA_ID'

    - id: 'setup_nodejs'
      run: |-
        apt update && \
          apt install node npm

    - id: 'setup_vite'
      run: |-
        npm install

    - name: 'build'
      run: |-
        npm run build

    - id: 'deploy'
      uses: 'google-github-actions/upload-cloud-storage@v1'
      with:
        path: './dist/'
        destination: '$GCS_PREFIX'
    

# jobs:
#   build-deploy:
#     name: Builds and releases the site
#     runs-on: ubuntu-latest

#     steps:
#       - name: checkout
#         uses: actions/checkout@v2

#       - name: Setup - gcloud / gsutil
#         uses: GoogleCloudPlatform/github-actions/setup-gcloud@v1
#         with:
#           service_account_key: ${{ secrets.GCS_SA_KEY }}
#           project_id: ${{ secrets.GCS_PROJECT }}
#           export_default_credentials: true

#       - name: Setup - nodejs
#         run: |-
#           apt update && \
#             apt install node npm

#       - name: Setup - vite
#         run: |-
#           npm install

#       - name: Build
#         run: |-
#           npm run build

#       - name: Deploy
#         run: |-
#           gsutil -m rsync -R dist gs://$GCS_BUCKET
